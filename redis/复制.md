# 复制

## 旧版复制功能的实现

   Redis的复制功能分为同步和命令传播两个操作 
   
   + 同步
        + 从服务器向主服务器发送SYNC命令
        + 收到SYNC命令的主服务器执行BGSAVE命令，在后台生产一个RDB文件，并使用一个缓冲区记录从现在开始执行的所有写命令
        + 当主服务器的BGSAVE命令执行完毕时，主服务器会将BGSAVE命令生产的RDB文件发送给从服务器，
           从服务器接收并载入这个RDB文件，将自己的数据库状态更新至主服务器执行BGSAVE时的状态
        + 主服务器将记录缓冲区里面的所有写命令发送给从服务器，从服务器执行这些写命令，
          将自己的数据库状态更新至主服务器数据库当前所处的状态。
   + 命令传播
        
        在同步操作执行完毕之后，主从服务器将达到一致状态，但每当主服务器执行客户端的写命令时，可能会导致主从不一致
   
   + 缺陷
        
        断线后重复制，需要重新复制一遍RDB文件，而不是复制断线期间的改动，非常耗费资源               

   +  新版复制功能的实现
        
        redis2.8起，使用PSYNC命令代替SYNC执行同步复制
      + 完整重同步，适用于初次复制
      + 部分重同步则用于处理断线后重复制情况：当从服务器在断线后重新连接上主服务器时，如果条件允许，主服务器将主从断线期间执行的命令发送给从服务器   
   
   
   + 实现
        + 复制偏移量
        + 复制积压缓冲区（默认一致） 
        + 服务器运行ID
        
        
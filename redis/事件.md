# 事件
    
    Redis服务器是一个事件驱动程序，服务器需要处理文件事件和时间事件两类事件。
    文件事件：Redis服务器通过套接字与客户端（或其他redis服务器）进行连接，
    而文件事件就是服务器对套接字操作的抽象。服务器与客户端的通信会产生相应的文件事件，
    而服务器则通过监听并处理这些事件来完成一系列的网络通信操作。
    时间事件：Redis服务器中的一些操作，需要定时执行，时间事件便是其抽象。
    
## 文件事件
    + Redis基于Reactor模式开发了自己的网络事件处理器，它被称为文件事件处理器
    + 文件事件处理器使用I/O多路复用程序来同时监听多个套接字，并根据套接字目前执行的任务来为套接字关联不同的事件处理器   
    + 当被监听的套接字准备好执行连接应答，读取，写入，关闭等操作时，与操作相对应的文件事件就会产生，这时文件事件处理器就会调用套接字之前关联好的事件处理器来处理这些事件。
    + 维护一个事件队列，有序，同步，每次一个套接字方式向文件事件分派器传送套接字
    
    ![avatar](https://outman-1252077993.cos.ap-nanjing.myqcloud.com/20180110195012499044.png)
    
    
+ I/O多路复用的实现

      select,epoll,evport,kqueue这些都有实现，根据不同os选择不同实现
      
      
+ 文件事件处理器
    
    + 连接应答处理器 —— 对连接服务器的各个客户端进行应答
    + 命令请求处理器 —— 接收客户端传来的命令
    + 命令回复处理器 —— 向客户端返回命令
    + 复制处理器 —— 处理主从复制操作
    ![客户端与服务器通信过程](https://outman-1252077993.cos.ap-nanjing.myqcloud.com/20200905155530592.png)
    
## 时间事件
    
   + 定时事件（目前没有定时事件）
   + 周期性事件
   + 属性  
        + id 全局唯一ID
        + when 毫秒精度的unix时间戳
        + timeProc 事件事件处理器 
        
   + 实现
        
         所有的时间事件维护在一个无序链表上，每当事件事件执行器运行时，遍历整个链表，查找所有已到达的时间事件，并调用相应的事件处理器
         
        ```
            def processTimeEvents();
                # 遍历服务器中所有的时间事件
                for time_event in all_time_event();
                    # 检查事件是否已经到达
                        if time_event.when<=uninx_now();
                            #事件已到达
                            # 执行事件处理器，并获取返回值
                            retval = time_event_timeProc();
                                
                            # 如果这是一个定时事件
                            if retval == AE_NOMORE;
                                
                               # 那么将该事件从服务器中删除
                               delete_time_event_from_server(time_event);
                            # 如果这是一个周期事件
                            else：
                            #那么按照事件处理器的返回值更新时间事件的 when 属性
                            #让这个事件在指定的时间之后再次到达
                            update_when(time_event,retval)    
        ``` 
   + serverCron 函数
        + 更新服务器的各类统计信息，比如时间，内存占用，数据库占用情况；
        + 清理数据库中的过期键值对
        + 关闭和清理失效的客户端
        + 尝试AOF或者RDB持久化操作
        + 如果服务器是主服务器，对从服务器进行定期同步
        + 如果处于集群模式，对集群进行定期同步和连接测试
        
   + 总结
        + Redis服务器是一个事件驱动程序，服务器处理的事件分为时间事件和文件事件两类
        + 文件事件处理器是基于Reactor模式实现的网络通信程序
        + 文件事件是对套接字操作的抽象：每次套接字变为可应答，可写，或者可读时，相应的文件事件就会产生
        + 文件事件分为AE_READABLE事件（读事件）和AE_WRITABLE事件
        + 时间事件分为定时事件和周期性事件：定时事件只在指定的时间到达一次，而周期性事件每隔一段时间到达一次
        + 服务器在一般情况下只执行serverCron函数一个时间事件，并且这个事件是周期性事件
        + 文件事件和时间事件之间是合作关系，服务器会轮流处理这两种事件，并且处理的过程中不会抢占
        + 时间事件的实际处理时间通常比设定要晚一点；                       
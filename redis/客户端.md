# 客户端
    
## 简介
        
        对于每个服务器进行连接的客户端，服务器都为这些客户端建立相应的redis.h/redisClient结构
        + 客户端的套接字描述符
        + 客户端的名字
        + 客户端的标志值
        + 指向客户端正在使用的数据库的指针，积极该数据库的号码
        + 客户端当前要执行的命令，命令的参数，命令参数的个数，以及指向命令实现函数的指针
        + 客户端的输入缓冲区的输出缓冲区
        + 客户端不的复制状态信息，以及进行复制所需的数据结构
        + 客户端执行BRPO,BLPOP等列表阻塞命令时使用的数据结构
        + 客户端的事务状态信息，以及执行WATCH命令时所用到的数据结构
        + 客户端执行发布与订阅功能时用到的数据结构
        + 客户端的身份验证标志
        + 客户端的创建时间，客户端和服务器最后一次通信的时间，以及客户端的输出缓冲区大小超出软性限制的时间 
        
 ## 客户端属性    
    
   + 套接字描述符
    
         客户端状态的fd属性记录了客户端正在使用的套接字描述符
        + 伪客户端，fd属性值为-1，用于载入AOF文件以及执行lua脚本
        + 普通客户端fd为大于-1的整数，用来与服务器建立通信
        
   + 名字
   
   + 标志
        
        客户端标志属性flags记录了客户端的角色，以及客户端目前所处的状态
            
        + 在主从服务器进行复制操作室，主从服务器互为客户端；REDIS_MASTER,REDIS_SALVE
        + REDIS_PRE_PSYNC标志表示客户端代表的是一个版本低于2.8的从服务器，主服务器不能使用PSYNC命令来进行同步
        + REDIS_LUA_CLIENT标识标识客户端是专门用于处理Lua脚本里面包含的Redis命令的伪客户端
        
        + REDIS_MONITOR 表示客户端目前正在执行MONITOR命令
        + REDIS_UNIX_SOCKET 标志表示服务器使用套接字来连接客户端
        + REDIS_BLOCKED 标志表示客户端正在被BRPOP,BLPOP等命令阻塞
        + REDIS_UNBLOCKED表示客户端从阻塞中脱离出来
        + REDIS_MULTI表示客户端正在执行事务
        + REDIS_DIRTY_CAS 标志表示事务使用WATCH命令见识的数据库键已经被修改,REDIS_DIRTY_EXEC 标志表示事务在命令入队时出现了错误                
        + REDIS_CLOSE_ASAP 标志表示客户端的输出缓冲区大小超出服务器所允许的范围，服务器会在下一次执行serverCron函数时关闭这个客户端。
        + REDIS_CLOSE_AFTER_REPLY 标志表示有用户对客户端执行了CLIENT_KILL命令。
        + REDIS_ASKING 标志表示客户端向集群节点发送了ASKING命令
        + REDIS_FORCE_AOF 标志强制服务器将当前执行的命令写入到AOF文件里面，
          REDIS_FORCE_REPL标志强制主服务器将当前执行的命令复制给所有从服务器
        + 在主从服务器进行命令传输期间，从服务器需要向主服务器发送REPLICATION_ACK命令。  
        
   + 输入缓冲区
   
         客户端状态的输入缓冲区用于保存客户端发送的命令，最大1G
   
   + 命令与命令参数
        
      ```
        typedef struct redisClient{
            // 命令数组，ARGV[0]是要执行的命令，其后是传给命令的参数
            robj **argv;
            // 记录数组的长度
            int argc;
            // .. 
        }
      ``` 
     
   + 命令的实现函数
    
        
        通过命令表字典结构实现，SDS键值保存命令的名字，当程序通过argv[0]找到对应的redisCommand结构，客户端状态的cmd指向它，随后便执行之
        
   + 输出缓冲区     
        
        每个客户端状态有两个缓冲区
        + 固定大小的缓冲区（字节数组，默认16K大小）保存比较小的回复，比如OK，简短的回复等等
        + 可变大小的缓冲区（当固定空间用完时启用），链表结构
        
   + 身份验证
        
        authenticated属性记录客户端是否通过身份验证，为0时只能执行AUTH命令
        
   + 时间   
   
## 客户端的创建与关闭
    
   + 创建普通客户端
      
       通过connect函数连接服务器，服务器通过连接事件处理器创建相应客户端状态，加入到client链表
   
   + 关闭普通客户端
    
        + 进程退出或被杀死
        + 客户端向服务器发送了不符合协议格式的命令请求
        + CLIENT KILL 命令关闭
        + timout关闭
        + 客户端发送的命令超过输入缓冲区限制的大小（默认1GB）
        + 命令回复超过输出缓冲区的大小 也会被关闭
    
   + lua脚本伪客户端
           
        与服务器生命周期一致
        
   + AOF文件伪客户端
   
             
               
            
          
     
         
        
        
        
                   
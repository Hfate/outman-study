# 最终一致性

   + CAP定理   
        ![](https://outman-1252077993.cos.ap-nanjing.myqcloud.com/CAP.jpg)
         
         如下三属性，任何一个联网的共享数据系统最多只能同时满足 2 个 
         一致性(Consistency) : 每次读取都会收到最新的写入或错误
         可用性(Availability) : 每个请求都会收到一个不是错误的响应
         分区容忍性(Partition tolerance) : 节点之间的网络丢弃（或延迟）了任意数量的消息，系统仍继续运行
    
    
    
   + BASE原则
        
         Basically Available : 基本可用
         Soft state : 软状态
         Eventual consistency : 最终一致性
         BASE原则发展自CAP定理，舍弃了系统的强一致性而选择AP，但每个应用可以根据自身的业务特点，采用适当的方式来使系统达到最终一致性。
         
   + XA协议(2PC)
   
       + 阶段 1：准备阶段
       
             协调者向所有参与者发送事务内容，询问是否可以提交事务，并等待所有参与者答复。
             各参与者执行事务操作，将 undo 和 redo 信息记入事务日志中（但不提交事务）。
             如参与者执行成功，给协调者反馈 yes，即可以提交；如执行失败，给协调者反馈 no，即不可提交。  
          
        ![](https://outman-1252077993.cos.ap-nanjing.myqcloud.com/2pc.png)   
       + 阶段 2：提交阶段
       
             如果协调者收到了参与者的失败消息或者超时，直接给每个参与者发送回滚(rollback)消息；否则，发送提交(commit)消息。
             参与者根据协调者的指令执行提交或者回滚操作，释放所有事务处理过程中使用的锁资源。(注意：必须在最后阶段释放锁资源) 接下来分两种情况分别讨论提交阶段的过程。
             情况 1，当所有参与者均反馈 yes，提交事务，如上图：
             协调者向所有参与者发出正式提交事务的请求（即 commit 请求）。
             参与者执行 commit 请求，并释放整个事务期间占用的资源。
             各参与者向协调者反馈 ack(应答)完成的消息。
             协调者收到所有参与者反馈的 ack 消息后，即完成事务提交。
       ![](https://outman-1252077993.cos.ap-nanjing.myqcloud.com/2pc2.png)     
   
   + TCC
        
         业务逻辑分为三块：Try、Confirm和Cancel三个操作。
         以在线下单为例，Try阶段会去锁定资源，Confirm阶段则是去更新资源状态，解除锁定，如果失败，则进入Cancel阶段，会去解除资源锁定，恢复原始状态；    
         
   + 消息事务+最终一致性
       ![](https://outman-1252077993.cos.ap-nanjing.myqcloud.com/%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E6%80%A7.png)    
       
         1、A系统向消息中间件发送一条预备消息
         2、消息中间件保存预备消息并返回成功
         3、A执行本地事务
         4、A发送提交消息给消息中间件
         通过以上4步完成了一个消息事务。对于以上的4个步骤，每个步骤都可能产生错误，下面一一分析：
            步骤一出错，则整个事务失败，不会执行A的本地操作
            步骤二出错，则整个事务失败，不会执行A的本地操作
            步骤三出错，这时候需要回滚预备消息，怎么回滚？答案是A系统实现一个消息中间件的回调接口，消息中间件会去不断执行回调接口，检查A事务执行是否执行成功，如果失败则回滚预备消息
            步骤四出错，这时候A的本地事务是成功的，那么消息中间件要回滚A吗？答案是不需要，其实通过回调接口，消息中间件能够检查到A执行成功了，这时候其实不需要A发提交消息了，消息中间件可以自己对消息进行提交，从而完成整个消息事务  
            
            
   + 常见处理手段
   
         重试
         幂等
         状态机
         恢复日志
         总结         